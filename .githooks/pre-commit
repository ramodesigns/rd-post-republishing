#!/bin/bash
#
# Pre-commit hook for RD Post Republishing
#
# This hook runs PHPStan and PHPCS on staged PHP files before allowing a commit.
# To install: git config core.hooksPath .githooks
#
# Exit codes:
# 0 - All checks passed
# 1 - Checks failed

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get list of staged PHP files
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.php$' || true)

if [ -z "$STAGED_PHP_FILES" ]; then
    echo -e "${GREEN}No PHP files staged. Skipping checks.${NC}"
    exit 0
fi

echo -e "Checking files:"
echo "$STAGED_PHP_FILES"
echo ""

# Check if vendor directory exists
if [ ! -d "vendor" ]; then
    echo -e "${RED}Error: vendor directory not found. Run 'composer install' first.${NC}"
    exit 1
fi

# Check PHP syntax
echo -e "${YELLOW}Checking PHP syntax...${NC}"
SYNTAX_ERROR=0
for file in $STAGED_PHP_FILES; do
    if [ -f "$file" ]; then
        php -l "$file" > /dev/null 2>&1 || {
            echo -e "${RED}Syntax error in: $file${NC}"
            php -l "$file"
            SYNTAX_ERROR=1
        }
    fi
done

if [ $SYNTAX_ERROR -ne 0 ]; then
    echo -e "${RED}PHP syntax check failed.${NC}"
    exit 1
fi
echo -e "${GREEN}PHP syntax check passed.${NC}"
echo ""

# Run PHPStan on staged files
echo -e "${YELLOW}Running PHPStan...${NC}"
PHPSTAN_FILES=""
for file in $STAGED_PHP_FILES; do
    if [ -f "$file" ]; then
        PHPSTAN_FILES="$PHPSTAN_FILES $file"
    fi
done

if [ -n "$PHPSTAN_FILES" ]; then
    if ! ./vendor/bin/phpstan analyse --no-progress $PHPSTAN_FILES; then
        echo -e "${RED}PHPStan check failed.${NC}"
        echo -e "Run 'composer phpstan' to see all errors."
        exit 1
    fi
    echo -e "${GREEN}PHPStan check passed.${NC}"
fi
echo ""

# Run PHPCS on staged files
echo -e "${YELLOW}Running PHPCS...${NC}"
PHPCS_FILES=""
for file in $STAGED_PHP_FILES; do
    if [ -f "$file" ]; then
        PHPCS_FILES="$PHPCS_FILES $file"
    fi
done

if [ -n "$PHPCS_FILES" ]; then
    if ! ./vendor/bin/phpcs --standard=phpcs.xml.dist $PHPCS_FILES; then
        echo -e "${RED}PHPCS check failed.${NC}"
        echo -e "Run 'composer phpcbf' to auto-fix some issues."
        exit 1
    fi
    echo -e "${GREEN}PHPCS check passed.${NC}"
fi
echo ""

echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
